---
title: "Title TBD"
date: "4/10/2018"
output: 
  html_document:
    toc: yes
    number_sections: true
---

<style>
/* resize the widget container */
.plotly { 
  width: 100% !important;
}

/* center the widget */
div.svg-container {
  margin: center !important;
}
</style>

\newcommand\prob{\mathbb{P}}
\newcommand\E{\mathbb{E}}
\newcommand\var{\mathrm{Var}}
\newcommand\cov{\mathrm{Cov}}
\newcommand\loglik{\ell}
\newcommand\R{\mathbb{R}}
\newcommand\data[1]{#1^*}
\newcommand\given{\, ; \,}
\newcommand\transpose{\scriptsize{T}}

```{r setup, include=FALSE}
# Install the following packages if missing
#install.packages("plotly")
#install.packages("tidyr")

knitr::opts_chunk$set(echo = T, warning = F, message = F, fig.align = "center", comment = "")

# Loading the required packages
library(tidyr)
library(ggplot2)
library(pomp)
library(parallel)
library(forecast)
```

# Introduction

## Background

## Object

# Summary of the data


```{r, echo=TRUE}
#blowfly <- read.csv("~/Google Drive/Courses/STATS_531/Final Project/blowfly.csv", header = T) # Local directory
#blowfly <- read.csv("/afs/umich.edu/user/z/h/zhhhwang/STATS531/blowfly.csv", header = T) # Server directory
blowfly <- read.csv("blowfly.csv", header = T) # Flux directory
head(blowfly)
```


```{r, echo=T}
ggplot(data = blowfly, aes(x = c(1:nrow(blowfly)), y = Population)) + geom_line() + xlab("Time")
```

# Detailed Analysis

## Spectrum and Correlation Analysis 

```{r, echo=T}
spectrum(blowfly$Population, spans = c(10,10))
```

```{r, echo=T}
acf(blowfly$Population)
```

```{r}
Org_low <- ts(loess(Population~Day,span=0.5,data= blowfly)$fitted)
Org_hi <- ts(blowfly$Population - loess(Population~Day,span=0.1,data= blowfly)$fitted)
Org_cycles <- blowfly$Population - Org_low - Org_hi
plot(ts.union(blowfly$Population, Org_low,Org_hi,Org_cycles),
     main="Decomposition of retail revenue as trend + Sesonal + Fluctuation")
```


## Fitting the ARMA Model

In order to find a way to match the patterns we discovered, fitting a ARMA model for this time series data is appropriate. Under the null hypothesis, we assume that the process is stationary, and the noise is i.i.d. Gaussian.    
/afs/umich.edu/user/z/h/zhhhwang
A ARMA(p,q) model is as follow **[3]**,
\[
  \phi(B)(X_{n} - \mu) = \psi(B)\epsilon_{n}
\]
Where
\[
  BX_{n} = X_{n-1} \quad \operatorname{and} \quad B\epsilon_{n} = \epsilon_{n-1}
\]
\[
  \mu = \E(X_{n})
\]
\[
  \phi(x) = 1-\sum_{i=1}^{p}\phi_{i}x^{i}
\]
\[
  \psi(x) = 1+\sum_{i=1}^{q}\psi_{i}x^{i}
\]
As we mentioned, under the null hypothesis, the noise are independently identically distributed as follow, 
\[
  \epsilon_{n} \sim N(0, \sigma^{2}).
\]

The $p$ and $q$ are tuning parameters. In order to choose the most suitable ones, we will be using AIC criterion, which is defined as follow,
\[
  \operatorname{AIC} = -2 \times \operatorname{likelihood}_{\theta} + 2\times D
\]
where $D = p+q+2$, i.e. the #parameter + 1. The smaller the AIC, the better the model is. The following is a table of different choice of $p$ and $q$, and the corresponding AIC value.  

```{r}
## AIC for arima model selection
aic_table <- function(data,P,Q){
  table <- matrix(NA,(P+1),(Q+1))
  for(p in 0:P) {
    for(q in 0:Q) {
       table[p+1,q+1] <- arima(data,order=c(p,0,q))$aic
    }
  }
  dimnames(table) <- list(paste("<b> AR",0:P, "</b>", sep=""),paste("MA",0:Q,sep=""))
  table
}

arma_table <- aic_table(blowfly$Population, 5, 4)
require(knitr)
kable(arma_table, digits=2)
```

```{r, echo=TRUE}
model <- arima(blowfly$Population, order = c(3,0,2))
model
```


```{r}
plot(blowfly$Population, type="l", main = "Original Data and Fitted Result")
lines(fitted(model),col="red")
```

```{r}
test = forecast(model,h=20)
plot(test, main = "Testing about the prediction of ARMA")
lines(blowfly$Population, type= "l", col = "red")
```



# POMP PART

Comparison between Hassel model and MSS model

```{r}
stochStep <- Csnippet("epsN = rlnorm(0, sigma*sigma);
                        N = (a*N/(1+pow(N/b,alpha)))*epsN;")

rmeas <- Csnippet("Population = rpois(phi*N);")
dmeas <- Csnippet("lik = dpois(Population, phi*N, give_log);")

blowfly_MSS <- pomp(blowfly,
     times = "Day", t0 = 0,
     rprocess = discrete.time.sim(step.fun = stochStep, delta.t = 2),
     paramnames = c("a", "b", "sigma", "alpha", "phi"),
     statenames = c("N", "epsN"),
     rmeasure = rmeas,
     dmeasure = dmeas
     ) 
```


```{r}
coef(blowfly_MSS) <- c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2400, sigma = 0.8, phi = 1, alpha = 0.8)
sims <- simulate(blowfly_MSS, nsim=3, as.data.frame = TRUE, include.data = TRUE)

ggplot(data = sims, mapping = aes(x = time, y = Population)) + geom_line() + facet_wrap(~sim)
```

```{r}
sliceDesign(
    c(N.0=948, epsN.0=0, a=2.5, b=2000, sigma=0.7, phi=1, alpha=1),
    a=rep(seq(from=1,to=3,length=5),each=3),
    b=rep(seq(from=1000,to=5000,length=5),each=3),
    sigma=rep(seq(from=0.6,to=1.0,length=5),each=3),
    alpha=rep(seq(from=0.3,to=1.0,length=5),each=3)
  ) -> p

blowfly_mle=unlist(p[which.max(p$loglik),])

require(foreach)
require(doMC)

registerDoMC(cores=3)   

set.seed(998468235L,kind="L'Ecuyer")
mcopts <- list(preschedule=FALSE,set.seed=TRUE)

foreach (theta=iter(p,"row"),.combine=rbind,
         .inorder=FALSE,.options.multicore=mcopts) %dopar% 
         {
           pfilter(blowfly_MSS,params=unlist(theta),Np=5000) -> pf
           theta$loglik <- logLik(pf)
           theta
         } -> p

foreach (v=c("a","b","sigma", "alpha")) %do% 
{
  x <- subset(p,slice==v)
  plot(x[[v]],x$loglik,xlab=v,ylab="loglik")
}
```

# Hassel

```{r}
stochStep <- Csnippet("epsN = rlnorm(0, sigma*sigma);
                        N = (a*N/pow(1+N/b,alpha))*epsN;")

rmeas <- Csnippet("Population = rpois(phi*N);")
dmeas <- Csnippet("lik = dpois(Population, phi*N, give_log);")

blowfly_Hassel <- pomp(blowfly,
     times = "Day", t0 = 0,
     rprocess = discrete.time.sim(step.fun = stochStep, delta.t = 2),
     paramnames = c("a", "b","sigma","alpha", "phi"),
     statenames = c("N","epsN"),
     rmeasure = rmeas,
     dmeasure = dmeas
     ) 
```


```{r}
coef(blowfly_Hassel) <- c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.8, phi = 1, alpha = 1)
sims <- simulate(blowfly_Hassel, nsim=3, as.data.frame = TRUE, include.data = TRUE)

ggplot(data = sims, mapping = aes(x = time, y = Population)) + geom_line() + facet_wrap(~sim)
```


```{r}
sliceDesign(
    c(N.0=948, epsN.0=0, a=2.5, b=2000, sigma=0.7, phi=1, alpha=1),
    a=rep(seq(from=1,to=3,length=50),each=3),
    b=rep(seq(from=1000,to=5000,length=50),each=3),
    sigma=rep(seq(from=0.6,to=1.0,length=50),each=3),
    alpha=rep(seq(from=0.6,to=1.0,length=50),each=3)
  ) -> p

blowfly_mle=unlist(p[which.max(p$loglik),])   

set.seed(998468235L,kind="L'Ecuyer")
mcopts <- list(preschedule=FALSE,set.seed=TRUE)

foreach (theta=iter(p,"row"),.combine=rbind,
         .inorder=FALSE,.options.multicore=mcopts) %dopar% 
         {
           pfilter(blowfly_Hassel,params=unlist(theta),Np=5000) -> pf
           theta$loglik <- logLik(pf)
           theta
         } -> p

foreach (v=c("a","b","sigma", "alpha")) %do% 
{
  x <- subset(p,slice==v)
  plot(x[[v]],x$loglik,xlab=v,ylab="loglik")
}
```


```{r}
simulate(blowfly_Hassel,params=c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8), nsim=10000,states=TRUE) -> x

ell <- dmeasure(blowfly_Hassel, y=obs(blowfly_Hassel), x=x, times=time(blowfly_Hassel),log=TRUE,
                params=c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8))
dim(ell)

ell <- apply(ell,1,sum); summary(exp(ell)); logmeanexp(ell,se=TRUE)
pf <- pfilter(blowfly_Hassel, Np=5000, params=c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8))
logLik(pf)

pf <- replicate(10,pfilter(blowfly_Hassel, Np=5000, params=c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8)))
ll <- sapply(pf,logLik)
ll

L_pf<-logmeanexp(ll,se=TRUE)
```

```{r}
run_level <- 3
switch(run_level,
       {blowfly_Np=100; blowfly_Nmif=10; blowfly_Neval=4; blowfly_Nglobal=10; blowfly_Nlocal=10}, 
       {blowfly_Np=1000; blowfly_Nmif=100; blowfly_Neval=10; blowfly_Nglobal=20; blowfly_Nlocal=20}, 
       {blowfly_Np=20000; blowfly_Nmif=400; blowfly_Neval=30; blowfly_Nglobal=200; blowfly_Nlocal=30}
)
```



```{r}
stew(file=sprintf("blowfly_local_search-%d.rda",run_level),{
  
  t_local <- system.time({
    mifs_local <- foreach(i=1:blowfly_Nlocal,.packages='pomp', .combine=c, .options.multicore=mcopts) %dopar%  {
      mif2(
        blowfly_Hassel,
        start=c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8),
        Np=blowfly_Np,
        Nmif=blowfly_Nmif,
        cooling.type="geometric",
        cooling.fraction.50=0.5,
        transform=TRUE,
        rw.sd=rw.sd(
          a=0.01,
          b=1,
          sigma=0.001,
          alpha = 0.01
        )
      )
      
    }
  })
  
},seed=900242057,kind="L'Ecuyer")


stew(file=sprintf("blowfly_lik_local-%d.rda",run_level),{
  t_local_eval <- system.time({
    liks_local <- foreach(i=1:blowfly_Nlocal,.packages='pomp',.combine=rbind) %dopar% {
      evals <- replicate(blowfly_Neval, logLik(pfilter(blowfly_Hassel, params=coef(mifs_local[[i]]),Np=blowfly_Np)))
      logmeanexp(evals, se=TRUE)
    }
  })
},seed=900242057,kind="L'Ecuyer")

blowfly_results_local <- data.frame(logLik=liks_local[,1],logLik_se=liks_local[,2],t(sapply(mifs_local,coef)))
summary(blowfly_results_local$logLik,digits=5)


pairs(~logLik+a+b+sigma+alpha,data=subset(blowfly_results_local,logLik>max(logLik)-50))
```


```{r}
blowfly_box <- rbind(
  a=c(2, 3),
  b=c(1000, 3000),
  sigma = c(0.5, 0.9),
  alpha = c(0.7, 1.2)
)

blowfly_fixed_params<-c(N.0 = 948, epsN.0 = 0, a = 2.5, b = 2000, sigma = 0.77, phi = 1, alpha = 0.8)

stew(file=sprintf("box_eval-%d.rda",run_level),{
  
  t_global <- system.time({
    mifs_global <- foreach(i=1:blowfly_Nglobal,.packages='pomp', .combine=c, .options.multicore=mcopts) %dopar%  mif2(
      mifs_local[[1]],
      start=c(apply(blowfly_box,1,function(x)runif(1,x[1],x[2])),blowfly_fixed_params)
    )
  })
},seed=1270401374,kind="L'Ecuyer")


stew(file=sprintf("lik_global_eval-%d.rda",run_level),{
  t_global_eval <- system.time({
    liks_global <- foreach(i=1:blowfly_Nglobal,.packages='pomp',.combine=rbind, .options.multicore=mcopts) %dopar% {
      evals <- replicate(blowfly_Neval, logLik(pfilter(blowfly_Hassel,params=coef(mifs_global[[i]]),Np=blowfly_Np)))
      logmeanexp(evals, se=TRUE)
    }
  })
},seed=442141592,kind="L'Ecuyer")

blowfly_results_global <- data.frame(logLik=liks_global[,1],logLik_se=liks_global[,2],t(sapply(mifs_global,coef)))
summary(blowfly_results_global$logLik,digits=5)
```


```{r}
if (run_level>2) 
  write.table(rbind(blowfly_results_local,blowfly_results_global),
              file="mif_blowfly_params.csv",append=TRUE,col.names=FALSE,row.names=FALSE)

pairs(~logLik+a+b+sigma+alpha,data=subset(blowfly_results_global,logLik>max(logLik)-250))
```

```{r}
plot(mifs_global)
```


# Reference

[1] https://en.wikipedia.org/wiki/Shanghai_Stock_Exchange       
[2] https://finance.yahoo.com     
[3] https://ionides.github.io/531w18/     
[4] https://stats.stackexchange.com/questions/6330/when-to-log-transform-a-time-series-before-fitting-an-arima-model     
